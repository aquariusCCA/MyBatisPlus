---
up:
  - "[[MyBatis Plus 課程描述]]"
---
# 1. 场景

> 一件商品，成本价是80元，售价是100元。老板先是通知小李，说你去把商品价格增加50元。小李正在玩游戏，耽搁了一个小时。正好一个小时后，老板觉得商品价格增加到150元，价格太高，可能会影响销量。又通知小王，你把商品价格降低30元。
> 
> 此时，小李和小王同时操作商品后台系统。小李操作的时候，系统先取出商品价格100元；小王也在操作，取出的商品价格也是100元。小李将价格加了50元，并将100+50=150元存入了数据库；小王将商品减了30元，并将100-30=70元存入了数据库。是的，如果没有锁，小李的操作就完全被小王的覆盖了。
>
> 现在商品价格是70元，比成本价低10元。几分钟后，这个商品很快出售了1千多件商品，老板亏1 万多。

---

# 2. 乐观锁与悲观锁

> 上面的故事，如果是乐观锁，小王保存价格前，会检查下价格是否被人修改过了。如果被修改过 
> 了，则重新取出的被修改后的价格，150元，这样他会将120元存入数据库。
>
> 如果是悲观锁，小李取出数据后，小王只能等小李操作完之后，才能对价格进行操作，也会保证 
> 最终的价格是120元。

---

# 3. 模拟修改冲突

## ①数据库中增加商品表

```mysql
CREATE TABLE t_product 
(
id BIGINT(20) NOT NULL COMMENT '主键ID',
NAME VARCHAR(30) NULL DEFAULT NULL COMMENT '商品名称',
price INT(11) DEFAULT 0 COMMENT '价格',
VERSION INT(11) DEFAULT 0 COMMENT '乐观锁版本号',
PRIMARY KEY (id)
);
```

## ②添加数据

```mysql
INSERT INTO t_product (id, NAME, price) VALUES (1, '外星人笔记本', 100);
```

## ③表结构

![[image-20230729173004901.png]]

## ④添加实体类

```java
package com.codechenxi.mybatis_plus.entity;

import com.baomidou.mybatisplus.annotation.TableField;
import lombok.Data;

@Data
public class Product {
    private Long id;
    @TableField("NAME")
    private String name;
    private Integer price;
    @TableField("VERSION")
    private Integer version;
}
```

## ⑤添加 mapper

```java
package com.codechenxi.mybatis_plus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.codechenxi.mybatis_plus.entity.Product;
import org.springframework.stereotype.Repository;

@Repository
public interface ProductMapper  extends BaseMapper<Product> {
}
```

## ⑥测试

```java
package com.codechenxi.mybatis_plus;

import com.codechenxi.mybatis_plus.entity.Product;
import com.codechenxi.mybatis_plus.mapper.ProductMapper;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
public class ProductTest {
    @Autowired
    private ProductMapper productMapper;

    @Test
    public void testProduct01(){
        // 小李查询商品价格
        // SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
        Product product1 = productMapper.selectById(1);
        System.out.println("小李取出的价格：" + product1.getPrice());

        // 小王查询商品价格
        // SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
        Product product2 = productMapper.selectById(1);
        System.out.println("小王取出的价格：" + product2.getPrice());

        // 小李将价格加了50元，存入了数据库
        // UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=?
        product1.setPrice(product1.getPrice() + 50);
        productMapper.updateById(product1);
        System.out.println("小李修改结果：" + product1.getPrice());

        // 小王将商品减了30元，存入了数据库
        // UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=?
        product2.setPrice(product2.getPrice() - 30);
        productMapper.updateById(product2);
        System.out.println("小王修改结果：" + product2.getPrice());

        // 最后的结果
        // SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
        Product product3 = productMapper.selectById(1);
        // 价格覆盖，最后的结果是：70
        System.out.println("最后的结果：" + product3.getPrice());
    }
}
```

## ⑦运行结果

![[image-20230729174034596.png]]

![[image-20230729174109492.png]]

![[image-20230729174131827.png]]

![[image-20230729174202056.png]]

---

# 4. 乐观锁实现流程

**Step1: 数据库中添加 version 字段。**

**Step2: 取出记录时，获取当前 version。**

```mysql
select id,NAME,price,VERSION from t_product where id = 1;
```

**Step3: 更新时，version + 1，如果 where 语句中的 version 版本不对，则更新失败。**

```mysql
update product set price = price + 50,VERSION = VERSION + 1 where id = 1 AND VERSION = 1;
```

---

# 5. MyBatis-Plus实现乐观锁

## ①修改实体类

```java
package com.codechenxi.mybatis_plus.entity;  
  
import com.baomidou.mybatisplus.annotation.TableField;  
import com.baomidou.mybatisplus.annotation.Version;  
import lombok.Data;  
  
@Data  
public class Product {  
    private Long id;  
    @TableField("NAME")  
    private String name;  
    private Integer price;  
    @TableField("VERSION")  
    @Version//标识乐观锁版本号字段  
    private Integer version;  
}
```

## ②添加乐观锁插件配置

```java
package com.codechenxi.mybatis_plus.config;


import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.OptimisticLockerInnerInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.codechenxi.mybatis_plus.mapper") //可以将主类中的注解移到此处
public class MybatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {

        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();

        // 添加分页插件
        mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));

        // 添加乐观锁插件
        mybatisPlusInterceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());

        return mybatisPlusInterceptor;
    }
}
```

## ③测试修改冲突

```java
@Test
public void testProduct02(){
	// 小李查询商品价格
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product1 = productMapper.selectById(1);
	System.out.println("小李取出的价格：" + product1.getPrice());

	// 小王查询商品价格
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product2 = productMapper.selectById(1);
	System.out.println("小王取出的价格：" + product2.getPrice());

	// 小李修改商品价格，自动将 version+1，存入数据库
	// UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=? AND VERSION=?
	product1.setPrice(product1.getPrice() + 50);
	productMapper.updateById(product1);
	System.out.println("小李修改结果：" + product1.getPrice());

	// 小王修改商品价格，此时version已更新，条件不成立，修改失败
	// UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=? AND VERSION=?
	product2.setPrice(product2.getPrice() - 30);
	productMapper.updateById(product2);
	System.out.println("小王修改结果：" + product2.getPrice());

	// 最终，小王修改失败，查询价格：150
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product3 = productMapper.selectById(1);
	// 价格覆盖，最后的结果是：150
	System.out.println("最后的结果：" + product3.getPrice());
}
```

## ④优化流程

```java
@Test
public void testProduct03(){
	// 小李取数据
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product1 = productMapper.selectById(1);

	// 小王取数据
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product2 = productMapper.selectById(1);


	// 小李修改 + 50
	// UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=? AND VERSION=?
	product1.setPrice(product1.getPrice() + 50);
	int result1 = productMapper.updateById(product1);
	System.out.println("小李修改的结果：" + result1);

	// 小王修改 - 30
	// UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=? AND VERSION=?
	product2.setPrice(product2.getPrice() - 30);
	int result2 = productMapper.updateById(product2);
	System.out.println("小王修改结果：" + result2);

	if(result2 == 0){
		// 失败重试，重新获取 version 并更新
		// UPDATE t_product SET NAME=?, price=?, VERSION=? WHERE id=? AND VERSION=?
		product2 = productMapper.selectById(1);
		product2.setPrice(product2.getPrice() - 30);
		result2 = productMapper.updateById(product2);
	}

	System.out.println("小王修改重试的结果：" + result2);

	// 老板看价格
	// SELECT id,NAME,price,VERSION FROM t_product WHERE id=?
	Product product3 = productMapper.selectById(1);
	System.out.println("老板看价格：" + product3.getPrice());
}
```

---