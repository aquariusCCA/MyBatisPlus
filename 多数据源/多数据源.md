---
up:
  - "[[MyBatis Plus 課程描述]]"
---
> 适用于多种场景：纯粹多库、  读写分离、  一主多从、  混合模式等
>
> 目前我们就来模拟一个纯粹多库的一个场景，其他场景类似
>
> 场景说明：
>
> 我们创建两个库，分别为：mybatis_plus（以前的库不动）与 mybatis_plus_1（新建），在mybatis_plus_1 库新建一张 product 表，这样每个库一张表，通过一个测试用例分别获取用户数据与商品数据，如果获取到说明多库模拟成功

---

# 1. 创建数据库及表

> 创建数据库 mybatis_plus_1 和表 product

```mysql
CREATE DATABASE mybatis_plus_1 /*!40100 DEFAULT CHARACTER SET utf8mb4 */; 
use mybatis_plus_1;

CREATE TABLE product 
(
id BIGINT(20) NOT NULL COMMENT '主键ID',
name VARCHAR(30) NULL DEFAULT NULL COMMENT '商品名称', 
price INT(11) DEFAULT 0 COMMENT '价格',
version INT(11) DEFAULT 0 COMMENT '乐观锁版本号', 
PRIMARY KEY (id)
);
```

> 添加测试数据

```mysql
INSERT INTO product (id, NAME, price) VALUES (1, '外星人笔记本', 100);
```

> 删除 mybatis_plus 库 t_product 表

```mysql
use mybatis_plus;
DROP TABLE IF EXISTS t_product;
```

---

# 2. 新建工程

略

---

# 3. 引入依赖

```xml
<dependencies>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter</artifactId>
	</dependency>

	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-test</artifactId>
		<scope>test</scope>
	</dependency>

	<!-- mybatis-plus 启动器 -->
	<dependency>
		<groupId>com.baomidou</groupId>
		<artifactId>mybatis-plus-spring-boot3-starter</artifactId>
		<version>3.5.12</version>
	</dependency>

	<!-- 動態數據源：Spring Boot 3.x 專用 -->
	<dependency>
		<groupId>com.baomidou</groupId>
		<artifactId>dynamic-datasource-spring-boot3-starter</artifactId>
		<version>4.3.1</version>
	</dependency>

	<!-- lombok 用于简化实体类开发 -->
	<dependency>
		<groupId>org.projectlombok</groupId>
		<artifactId>lombok</artifactId>
		<scope>annotationProcessor</scope>
	</dependency>

	<!-- mysql 驱动 -->
	<dependency>
		<groupId>com.mysql</groupId>
		<artifactId>mysql-connector-j</artifactId>
		<scope>runtime</scope>
	</dependency>
</dependencies>
```

---

# 4. 配置多个数据源

> 说明：注释掉之前的数据库连接，添加新配置

```yml
spring:
  datasource:
    dynamic:
      primary: master #设置默认的数据源或者数据源组,默认值即为master
      strict: false #严格匹配数据源,默认false. true未匹配到指定数据源时抛异常,false使用默认数据源
      datasource:
        master:
          url: jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=GMT%2B8&characterEncoding=utf-8&useSSL=false
          username: root
          password: Lins860210SStar
          driver-class-name: com.mysql.cj.jdbc.Driver
        slave_1:
          url: jdbc:mysql://localhost:3306/mybatis_plus_1?serverTimezone=GMT%2B8&characterEncoding=utf-8&useSSL=false
          username: root
          password: Lins860210SStar
          driver-class-name: com.mysql.cj.jdbc.Driver
```

---

# 5. 新建实体类

```java
package com.codechenxi.mybatis_plus.entity;

import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("t_user")
public class User {
    @TableId
    private Integer uid;
    @TableField("username")
    private String userName;
    private Integer age;
    private Integer sex;
    private String email;
    private Integer isDeleted;
}
```

```java
package com.codechenxi.mybatis_plus.entity;

import lombok.Data;

@Data
public class Product {
    private Integer id;
    private String name;
    private Integer price;
    private Integer version;
}
```

---

# 6. 新建 Mapper 接口

```java
package com.codechenxi.mybatis_plus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.codechenxi.mybatis_plus.entity.User;
import org.springframework.stereotype.Repository;

@Repository
public interface UserMapper extends BaseMapper<User> {
}
```

```java
package com.codechenxi.mybatis_plus.mapper;  
  
import com.baomidou.mybatisplus.core.mapper.BaseMapper;  
import com.codechenxi.mybatis_plus.entity.Product;  
import org.springframework.stereotype.Repository;  
  
@Repository  
public interface ProductMapper  extends BaseMapper<Product> {  
}
```

---

# 7. 配置启动类

```java
package com.codechenxi.mybatis_plus;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan("com.codechenxi.mybatis_plus.mapper")
public class MybatisPlusDatasourceApplication {
    public static void main(String[] args) {
        SpringApplication.run(MybatisPlusDatasourceApplication.class, args);
    }
}
```

---

# 8. 创建用户接口和接口实现类

```java
package com.codechenxi.mybatis_plus.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.codechenxi.mybatis_plus.entity.User;

public interface UserService  extends IService<User> {
}
```

```java
package com.codechenxi.mybatis_plus.service.impl;

import com.baomidou.dynamic.datasource.annotation.DS;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.codechenxi.mybatis_plus.mapper.UserMapper;
import com.codechenxi.mybatis_plus.service.UserService;
import org.springframework.stereotype.Service;
import com.codechenxi.mybatis_plus.entity.User;

@DS("master")
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
}
```

---

# 9. 创建商品接口和接口实现类

```java
package com.codechenxi.mybatis_plus.service;  
  
import com.baomidou.mybatisplus.extension.service.IService;  
import com.codechenxi.mybatis_plus.entity.Product;  
  
public interface ProductService  extends IService<Product> {  
}
```

```java
package com.codechenxi.mybatis_plus.service.impl;  
  
import com.baomidou.dynamic.datasource.annotation.DS;  
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;  
import com.codechenxi.mybatis_plus.entity.Product;  
import com.codechenxi.mybatis_plus.mapper.ProductMapper;  
import com.codechenxi.mybatis_plus.service.ProductService;  
import org.springframework.stereotype.Service;  
  
@DS("slave_1")  
@Service  
public class ProductServiceImpl  extends ServiceImpl<ProductMapper, Product> implements ProductService {  
}
```

---

# 10. 测试

```java
package com.codechenxi.mybatis_plus;

import com.codechenxi.mybatis_plus.service.ProductService;
import com.codechenxi.mybatis_plus.service.UserService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

/**
 * @author codechenxi@126.com
 * @version 1.0
 * @date 2023/7/29 18:49
 */

```

**运行结果**

![[image-20230729185224198.png]]

> 结果：
> 1、都能顺利获取对象，则测试成功
> 2、如果我们实现读写分离，将写操作方法加上主库数据源，读操作方法加上从库数据源，自动切换，是不是就能实现读写分离？

---